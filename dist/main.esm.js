var t=function(t,n){if(null==t)return{};var e,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)e=i[r],n.indexOf(e)>=0||(o[e]=t[e]);return o};var n=function(n,e){if(null==n)return{};var r,o,i=t(n,e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(n);for(o=0;o<c.length;o++)r=c[o],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(n,r)&&(i[r]=n[r])}return i};var e=function(t){if(Array.isArray(t))return t};var r=function(t,n){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var e=[],r=!0,o=!1,i=void 0;try{for(var c,u=t[Symbol.iterator]();!(r=(c=u.next()).done)&&(e.push(c.value),!n||e.length!==n);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return e}};var o=function(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r};var i=function(t,n){if(t){if("string"==typeof t)return o(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?o(t,n):void 0}};var c=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var u=function(t,n){return e(t)||r(t,n)||i(t,n)||c()};var s=function(t){if(Array.isArray(t))return o(t)};var a=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var f=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var l=function(t){return s(t)||a(t)||i(t)||f()};var d=function(t,n){return t(n={exports:{}},n.exports),n.exports}((function(t){var n=function(t){var n=Object.prototype,e=n.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",i=r.asyncIterator||"@@asyncIterator",c=r.toStringTag||"@@toStringTag";function u(t,n,e,r){var o=n&&n.prototype instanceof f?n:f,i=Object.create(o.prototype),c=new E(r||[]);return i._invoke=function(t,n,e){var r="suspendedStart";return function(o,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw i;return S()}for(e.method=o,e.arg=i;;){var c=e.delegate;if(c){var u=b(c,e);if(u){if(u===a)continue;return u}}if("next"===e.method)e.sent=e._sent=e.arg;else if("throw"===e.method){if("suspendedStart"===r)throw r="completed",e.arg;e.dispatchException(e.arg)}else"return"===e.method&&e.abrupt("return",e.arg);r="executing";var f=s(t,n,e);if("normal"===f.type){if(r=e.done?"completed":"suspendedYield",f.arg===a)continue;return{value:f.arg,done:e.done}}"throw"===f.type&&(r="completed",e.method="throw",e.arg=f.arg)}}}(t,e,c),i}function s(t,n,e){try{return{type:"normal",arg:t.call(n,e)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var a={};function f(){}function l(){}function d(){}var h={};h[o]=function(){return this};var v=Object.getPrototypeOf,p=v&&v(v(D([])));p&&p!==n&&e.call(p,o)&&(h=p);var y=d.prototype=f.prototype=Object.create(h);function m(t){["next","throw","return"].forEach((function(n){t[n]=function(t){return this._invoke(n,t)}}))}function g(t,n){var r;this._invoke=function(o,i){function c(){return new n((function(r,c){!function r(o,i,c,u){var a=s(t[o],t,i);if("throw"!==a.type){var f=a.arg,l=f.value;return l&&"object"==typeof l&&e.call(l,"__await")?n.resolve(l.__await).then((function(t){r("next",t,c,u)}),(function(t){r("throw",t,c,u)})):n.resolve(l).then((function(t){f.value=t,c(f)}),(function(t){return r("throw",t,c,u)}))}u(a.arg)}(o,i,r,c)}))}return r=r?r.then(c,c):c()}}function b(t,n){var e=t.iterator[n.method];if(void 0===e){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=void 0,b(t,n),"throw"===n.method))return a;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return a}var r=s(e,t.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,a;var o=r.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=void 0),n.delegate=null,a):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,a)}function w(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function _(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function E(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(w,this),this.reset(!0)}function D(t){if(t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function n(){for(;++r<t.length;)if(e.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=void 0,n.done=!0,n};return i.next=i}}return{next:S}}function S(){return{value:void 0,done:!0}}return l.prototype=y.constructor=d,d.constructor=l,d[c]=l.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===l||"GeneratorFunction"===(n.displayName||n.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):(t.__proto__=d,c in t||(t[c]="GeneratorFunction")),t.prototype=Object.create(y),t},t.awrap=function(t){return{__await:t}},m(g.prototype),g.prototype[i]=function(){return this},t.AsyncIterator=g,t.async=function(n,e,r,o,i){void 0===i&&(i=Promise);var c=new g(u(n,e,r,o),i);return t.isGeneratorFunction(e)?c:c.next().then((function(t){return t.done?t.value:c.next()}))},m(y),y[c]="Generator",y[o]=function(){return this},y.toString=function(){return"[object Generator]"},t.keys=function(t){var n=[];for(var e in t)n.push(e);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=D,E.prototype={constructor:E,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!t)for(var n in this)"t"===n.charAt(0)&&e.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e,r){return c.type="throw",c.arg=t,n.next=e,r&&(n.method="next",n.arg=void 0),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],c=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var u=e.call(i,"catchLoc"),s=e.call(i,"finallyLoc");if(u&&s){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&e.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var c=i?i.completion:{};return c.type=t,c.arg=n,i?(this.method="next",this.next=i.finallyLoc,a):this.complete(c)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),a},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),_(e),a}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var e=this.tryEntries[n];if(e.tryLoc===t){var r=e.completion;if("throw"===r.type){var o=r.arg;_(e)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,e){return this.delegate={iterator:D(t),resultName:n,nextLoc:e},"next"===this.method&&(this.arg=void 0),a}},t}(t.exports);try{regeneratorRuntime=n}catch(t){Function("r","regeneratorRuntime = r")(n)}}));function h(t,n,e,r,o,i,c){try{var u=t[i](c),s=u.value}catch(t){return void e(t)}u.done?n(s):Promise.resolve(s).then(r,o)}var v=function(t){return function(){var n=this,e=arguments;return new Promise((function(r,o){var i=t.apply(n,e);function c(t){h(i,r,o,c,u,"next",t)}function u(t){h(i,r,o,c,u,"throw",t)}c(void 0)}))}};var p=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")};function y(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var m=function(t,n,e){return n&&y(t.prototype,n),e&&y(t,e),t};var g=function(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t};function b(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function w(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?b(Object(e),!0).forEach((function(n){g(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):b(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}var _=function(){function t(e,r){var o=this;p(this,t),g(this,"db",void 0),g(this,"dbName",void 0),g(this,"httpClient",void 0),g(this,"takeSyncActions",{delete:function(t,n){return o.deleteSyncAction(t,n)},add:function(t,n){return o.addSyncAction(t,n)},update:function(t,n){return o.updateSyncAction(t,n)}}),g(this,"testDocType",{isArray:function(t){return"[object Array]"===toString.call(t)},isObject:function(t){return"[object Object]"===toString.call(t)},hasID:function(t){return"_id"in t},hasRev:function(t){return"_rev"in t}}),g(this,"docPutErrors",[{test:function(t){return!o.testDocType.isObject(t)},error:{status:400,name:"bad_request",message:"Document must be a JSON object",error:!0}},{test:function(t){return!o.testDocType.hasID(t)},error:{status:412,name:"missing_id",message:"_id is required for puts",error:!0}},{test:function(){return!0},error:void 0}]),g(this,"putDocActions",[{test:function(t){return!!o.docPutErrors.find((function(n){return n.test(t)})).error},action:function(t){return Promise.reject(o.docPutErrors.find((function(n){return n.test(t)})).error)}},{test:function(t){return"_rev"in t},action:function(t){return o.getRev(t._id).then((function(n){return o.checkDocRevWithDBRev(t,n)})).catch((function(){return Promise.reject(o.docUpdateConflictError(t._id))}))}},{test:function(t){return!("_rev"in t)},action:function(t){return o.addDocIfIdIsNew(t).catch((function(){return Promise.reject(o.docUpdateConflictError(t._id))}))}}]),g(this,"allDocsActions",[{test:function(t){return!t},action:function(){return o.getAllDocs().then((function(t){return o.mapAllDocs2Response(o.map2AllDoc)(t)}))}},{test:function(t){return 1==Object.keys(t).length&&'{"include_docs":true}'==JSON.stringify(t)},action:function(){return o.getAllDocs().then((function(t){return o.mapAllDocs2Response(o.map2AllFullDoc)(t)}))}},{test:function(t){return"keys"in t&&t.keys.length>0},action:function(t){return o.getMultiDocs(o.ids2QueryString(t.keys)).then((function(n){return Promise.resolve({total_rows:n.length,offset:0,rows:t.keys.reduce((function(t,e){var r=n._array.find((function(t){return t.doc_id===e})),i=r?o.map2AllFullDoc(r):{key:e,error:"not_found"};return t.push(i),t}),[])})}))}},{test:function(t){return"keys"in t&&0==t.keys.length},action:function(){return o.getAllDocs().then((function(t){return Promise.resolve({total_rows:t.length,offset:void 0,rows:[]})}))}},{test:function(t){return"startkey"in t&&"endkey"in t&&(!("include_docs"in t)||!0!==t.include_docs)},action:function(t){return o.getAllDocsWithStartId(t.startkey).then((function(t){return o.mapAllDocs2Response(o.map2AllDoc)(t)}))}},{test:function(t){return"startkey"in t&&"endkey"in t&&"include_docs"in t&&1==t.include_docs},action:function(t){return o.getAllDocsWithStartId(t.startkey).then((function(t){return o.mapAllDocs2Response(o.map2AllFullDoc)(t)}))}},{test:function(){return!0},action:function(){return Promise.reject({})}}]),g(this,"getTx",v(d.mark((function t(){return d.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,n){return o.db.transaction((function(n){return t(n)}),(function(t){return n(t)}))})));case 1:case"end":return t.stop()}}),t)})))),g(this,"getAllRows",(function(){return new Promise((function(t,n){return o.db.transaction((function(e){return e.executeSql('SELECT * FROM "by-sequence"',[],(function(n,e){return t([n,e])}),(function(t,e){return n([t,e])}))}))}))})),g(this,"mapDocRows",(function(t){return Object.keys(t.rows).map((function(n){return t.rows[n]}))[0]})),g(this,"getRevInt",(function(t){return parseInt(t.split("-")[0])})),g(this,"compareLocalDocs",(function(t,n){return t.doc_id!==n.doc_id||o.getRevInt(t.rev)>o.getRevInt(n.rev)})),g(this,"compareSyncDocs",(function(t,n){return t.id!==n.id||o.getRevInt(t.value.rev)>o.getRevInt(n.value.rev)})),g(this,"check4SameID",(function(t,n){return!!t.find((function(t){return t.doc_id===n.doc_id}))})),g(this,"filterOldLocalRevs",(function(t){return t.reduce((function(t,n){var e=t.filter((function(t){return o.compareLocalDocs(t,n)}));return o.check4SameID(e,n)?e:[].concat(l(e),[n])}),[])})),g(this,"deleteRev",(function(t,n){return new Promise((function(e,r){return t.executeSql('DELETE FROM "by-sequence" WHERE\n             doc_id = "'.concat(n.doc_id,'"\n             AND rev = "').concat(n.rev,'"'),[],(function(){return e()}),(function(t){return r(t)}))}))})),g(this,"killOldRevs",(function(t,n){return o.getTx().then((function(e){return Promise.all(t.filter((function(t){return!n.includes(t)})).map((function(t){return o.deleteRev(e,t)})))}))})),g(this,"pruneOldLocalRevs",(function(){return o.getAllRows().then((function(t){var n=u(t,2),e=(n[0],n[1]),r=o.mapDocRows(e),i=o.filterOldLocalRevs(r);return o.killOldRevs(r,i)}))})),g(this,"getTables",(function(){return new Promise((function(t,n){return o.db.readTransaction((function(e){return e.executeSql('SELECT tbl_name from sqlite_master WHERE type = "table"',[],(function(n,e){return t([n,e])}),(function(t,e){return n([t,e])}))}))})).then((function(t){var n=u(t,2),e=(n[0],n[1].rows._array.map((function(t){return t.tbl_name})));return Promise.resolve(e)}))})),g(this,"drobTable",(function(t,n){return new Promise((function(e,r){return t.executeSql('DROP TABLE "'.concat(n,'"'),[],(function(t,n){return e([t,n])}),(function(t,n){return r([t,n])}))}))})),g(this,"dropFunnyTables",(function(){return o.getTx().then((function(t){return Promise.all(["attach-store","local-store","attach-seq-store","document-store","metadata-store"].map((function(n){return o.drobTable(t,n)})))}))})),g(this,"getLocalAllDocs",(function(){return o.getAllRows().then((function(t){var n=u(t,2),e=(n[0],n[1]),r=o.mapDocRows(e),i={total_rows:r.length,offset:0,rows:r.map((function(t){return{id:t.doc_id,key:t.doc_id,value:{rev:t.rev}}}))};return Promise.resolve(i)}))})),g(this,"getCleanAllDocRows",(function(t){return t.rows.filter((function(t){return"_design/access"!==t.id}))})),g(this,"sameIdNHigherRev",(function(t){return function(n){return t.id===n.id&&o.getRevInt(t.value.rev)<o.getRevInt(n.value.rev)}})),g(this,"map2SyncAction",(function(t){return function(n){return{state:t,id:n.id}}})),g(this,"getChangedDocs",(function(t,n){return t.filter((function(t){return!!n.find(o.sameIdNHigherRev(t))})).map(o.map2SyncAction("update"))})),g(this,"getExclusiveDocs",(function(t,n,e){return t.filter((function(t){return!n.find((function(n){return t.id===n.id}))})).map(o.map2SyncAction(e))})),g(this,"compareWithRemote",(function(t){var n=u(t,2),e=n[0],r=n[1],i=o.getChangedDocs(e,r),c=o.getExclusiveDocs(r,e,"add"),s=o.getExclusiveDocs(e,r,"delete");return[].concat(l(i),l(c),l(s))})),g(this,"updateSyncAction",(function(t,e){return new Promise((function(r,o){var i=e.doc,c=(i._id,i._rev,n(i,["_id","_rev"])),u=e.doc,s=n(e,["doc"]);t.executeSql('UPDATE "by-sequence" SET json = ?, rev = ?  WHERE doc_id = ?',[JSON.stringify(c),u._rev,u._id],(function(t,n){return r([t,w(w({},s),{done:"success"})])}),(function(t,n){return o([t,n])}))}))})),g(this,"addSyncAction",(function(t,e){return new Promise((function(r,o){var i=e.doc,c=(i._id,i._rev,n(i,["_id","_rev"])),u=e.doc,s=n(e,["doc"]);t.executeSql('INSERT INTO "by-sequence" (json, deleted, doc_id, rev)\n                 VALUES (?, ?, ?, ?)',[JSON.stringify(c),0,u._id,u._rev],(function(t,n){return r([t,w(w({},s),{done:"success"})])}),(function(t,n){return o([t,n])}))}))})),g(this,"deleteSyncAction",(function(t,n){return new Promise((function(e,r){return t.executeSql('DELETE FROM "by-sequence" WHERE doc_id = ?',[n.id],(function(t,r){return e([t,w(w({},n),{done:"success"})])}),(function(t,n){return r([t,n])}))}))})),g(this,"getRemoteDoc",(function(t){return o.httpClient.get("http://127.0.0.1:3000/".concat(t))})),g(this,"getAllRemoteDocs",(function(){return o.httpClient.get("http://127.0.0.1:3000/_all_docs?include_docs=true")})),g(this,"convertDoc2Map",(function(t,n){return t[n.id]=n.doc,t})),g(this,"enrichDocSyncAction",(function(t,n){return"delete"!==t.state?w(w({},t),{doc:n[t.id]}):t})),g(this,"getRemoteDocs4SyncActions",(function(t){return o.getAllRemoteDocs().then((function(n){var e=n.rows.filter((function(t){return"_design/access"!==t.id})).reduce(o.convertDoc2Map,{}),r=t.reduce((function(t,n){return[].concat(l(t),[o.enrichDocSyncAction(n,e)])}),[]);return Promise.resolve(r)}))})),g(this,"enrichSyncActionsWithDocs",(function(t){return t.find((function(t){return"update"===t.state||"add"===t.state}))?o.getRemoteDocs4SyncActions(t):Promise.resolve(t)})),g(this,"syncAction2DB",(function(t,n){return n.map((function(n){return o.takeSyncActions[n.state](t,n)}))})),g(this,"syncAllActions2DB",(function(t){return o.getTx().then((function(n){return Promise.all(o.syncAction2DB(n,t))}))})),g(this,"processSyncActions",(function(t){return 0==t.length?Promise.resolve([]):o.enrichSyncActionsWithDocs(t).then((function(t){return o.syncAllActions2DB(t)}))})),g(this,"getDumpRows",(function(t){var n=t.split("\n");return 3===n.length?Promise.resolve(JSON.parse(n[1]).docs):o.httpClient.get(t).then((function(t){return o.getDumpRows(t)}))})),g(this,"insertDumpRows",(function(t){return o.getTx().then((function(n){var e=t.map((function(t){return{state:"add",id:t._id,doc:t}})).map((function(t){return o.addSyncAction(n,t)}));return Promise.all(e)}))})),g(this,"initDBtable",(function(){return new Promise((function(t){return o.db.transaction((function(n){return n.executeSql('CREATE TABLE IF NOT EXISTS "by-sequence" (\n                        seq INTEGER PRIMARY KEY,\n                        json TEXT,\n                        deleted INT,\n                        doc_id TEXT unique,\n                        rev TEXT\n                    )',[],(function(){return t()}),(function(n,e){return t()}))}))}))})),g(this,"getDocCount",(function(){return new Promise((function(t,n){return o.db.readTransaction((function(e){return e.executeSql('SELECT COUNT(*) as "docCount" FROM "by-sequence"',[],(function(n,e){return t(e.rows._array[0].docCount)}),(function(t,e){return n(e)}))}))}))})),g(this,"getSingleDoc",(function(t){return new Promise((function(n,e){return o.db.readTransaction((function(r){return r.executeSql('SELECT * FROM "by-sequence" WHERE doc_id="'.concat(t,'"'),[],(function(t,e){return n(e.rows._array[0])}),(function(t,n){return e(n)}))}))}))})),g(this,"ids2QueryString",(function(t){return t.map((function(t){return'"'.concat(t,'"')})).join(", ")})),g(this,"getMultiDocs",(function(t){return new Promise((function(n,e){return o.db.readTransaction((function(r){return r.executeSql('SELECT * FROM "by-sequence" WHERE doc_id IN ('.concat(t,")"),[],(function(t,e){return n(e.rows)}),(function(t,n){return e(n)}))}))}))})),g(this,"getAllDocs",(function(){return new Promise((function(t,n){return o.db.readTransaction((function(e){return e.executeSql('SELECT * FROM "by-sequence"',[],(function(n,e){return t(e.rows)}),(function(t,e){return n(e)}))}))}))})),g(this,"getAllDocsWithStartId",(function(t){return new Promise((function(n,e){return o.db.readTransaction((function(r){return r.executeSql('SELECT * FROM "by-sequence" WHERE doc_id LIKE "'.concat(t,'%"'),[],(function(t,e){return n(e.rows)}),(function(t,n){return e(n)}))}))}))})),g(this,"getRev",(function(t){return new Promise((function(n,e){return o.db.readTransaction((function(r){return r.executeSql('SELECT rev FROM "by-sequence" WHERE doc_id="'.concat(t,'"'),[],(function(t,r){return r.rows.length>0&&"rev"in r.rows._array[0]?n(r.rows._array[0].rev):e()}),(function(t,n){return e(n)}))}))}))})),g(this,"checkDocId",(function(t){return new Promise((function(n,e){return o.db.readTransaction((function(r){return r.executeSql('SELECT doc_id FROM "by-sequence" WHERE doc_id="'.concat(t,'"'),[],(function(r,o){0===o.rows.length?n(r):e("Doc with id: ".concat(t," already in db!"))}),(function(t,e){return n(t)}))}))}))})),g(this,"insertDoc",(function(t,e){return new Promise((function(r,o){var i=e.id,c=(e.rev,n(e,["id","rev"]));console.log(e),t.executeSql('INSERT INTO "by-sequence" (json, deleted, doc_id, rev)\n                 VALUES (?, ?, ?, ?)',[JSON.stringify(c),0,i,"1-YYY"],(function(t,n){console.log("SUCCESS"),console.log(n),r(t)}),(function(t,n){console.log(n),o(n)}))}))})),g(this,"count2InfoObject",(function(t){return{doc_count:t,update_seq:t,websql_encoding:"UTF-8",db_name:o.db._db._db.filename,auto_compaction:!1,adapter:"websql"}})),g(this,"getDocResponse",(function(t){var n=JSON.parse(t.json);return n._id=t.doc_id,n._rev=t.rev,n})),g(this,"getDocError",(function(t){return{status:404,name:"not_found",message:"missing",error:!0,reason:"missing",docId:t}})),g(this,"map2AllDoc",(function(t){return{id:t.doc_id,key:t.doc_id,value:{rev:t.rev}}})),g(this,"map2AllFullDoc",(function(t){return{id:t.doc_id,key:t.doc_id,value:{rev:t.rev},doc:w(w({},JSON.parse(t.json)),{_id:t.doc_id,_rev:t.rev})}})),g(this,"mapAllDocs2Response",(function(t){return function(n){return Promise.resolve({total_rows:n.length,offset:0,rows:n._array.map(t)})}})),g(this,"docUpdateConflictError",(function(t){return{status:409,name:"conflict",message:"Document update conflict",error:!0,id:t,docId:t}})),g(this,"fakeHash4oldRev",(function(t){return(o.getRevInt(t)+1).toString()+t.slice(1)})),g(this,"checkDocRevWithDBRev",(function(t,n){return new Promise((function(e,r){return n===t._rev?e({ok:!0,id:t._id,rev:o.fakeHash4oldRev(n)}):r()}))})),g(this,"doc2SyncAction",(function(t){return{state:"add",id:t._id,doc:w(w({},t),{_rev:"1-XXX"})}})),g(this,"addDocIfIdIsNew",(function(t){return o.checkDocId(t._id).then((function(){return o.getTx()})).then((function(n){console.log("trying to put "+t._id),console.log("IS IT running? "+n._running);var e=o.doc2SyncAction(t);return o.addSyncAction(n,e)}))})),this.db=e,this.dbName=e._db._db.filename,this.httpClient=r}return m(t,[{key:"load",value:function(t){var n=this;return this.initDBtable().then((function(){return n.getDumpRows(t)})).then((function(t){return n.insertDumpRows(t)}))}},{key:"info",value:function(){var t=this;return this.getDocCount().then(this.count2InfoObject).catch((function(){return t.initDBtable().then((function(){return t.getDocCount()})).then(t.count2InfoObject)}))}},{key:"get",value:function(t){var n=this;return new Promise((function(e,r){return n.getSingleDoc(t).then((function(t){return e(n.getDocResponse(t))})).catch((function(e){return r(n.getDocError(t))}))}))}},{key:"allDocs",value:function(t){return this.allDocsActions.find((function(n){return n.test(t)})).action(t)}},{key:"put",value:function(t){return this.putDocActions.find((function(n){return n.test(t)})).action(t)}}]),t}();export{_ as OuchDB};
//# sourceMappingURL=main.esm.js.map
